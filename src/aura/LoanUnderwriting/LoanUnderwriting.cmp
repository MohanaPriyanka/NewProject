<aura:component controller="LoanUnderwriting" extends="c:BlueWaveParent">
  <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
  <aura:handler event="aura:waiting" action="{!c.waiting}"/>
  <aura:handler event="aura:doneWaiting" action="{!c.doneWaiting}"/>
  <aura:handler event="c:LoanUnderwritingIncomeAdjustment" action="{!c.handleEvent}"/>
  <aura:handler event="c:LoanUnderwritingDebtAdjustment" action="{!c.handleEvent}"/>
  <aura:attribute name="leadId" type="String"/>
  <aura:attribute name="lead" type="Lead"/>
  <aura:attribute name="hasCoApp" type="Boolean" default="false"/>
  <aura:attribute name="bestFICO" type="Integer"/>
  <aura:attribute name="bestDTI" type="Decimal"/>
  <aura:attribute name="combinedIncome" type="Decimal"/>
  <aura:attribute name="mainPCRAttachment" type="Attachment"/>
  <aura:attribute name="coAppPCRAttachment" type="Attachment"/>
  <aura:attribute name="waiting" type="Boolean" default="false"/>

  <c:LightningErrorHandler />

  <aura:if isTrue="{!v.waiting}">
    <lightning:spinner alternativeText="Saving..." class="slds-is-fixed" size="medium"/>
  </aura:if>

  <div class="slds-grid slds-grid_align-spread">
    <div class="slds-col slds-align-middle">
      <h1 class="slds-text-heading_large" title="Customer Name">
        <ui:outputText class="slds-text-color_inverse" value="{!v.lead.Name}"/>
      </h1>
      <aura:if isTrue="{!v.lead.Product__r != null}">
        <div class="slds-text-body_small slds-text-color_inverse">
          <ui:outputText value="{!v.lead.Product__r.Name}"/> 
          (Min FICO: <ui:outputText value="{!v.lead.Product__r.Credit_Minimum__c}"/>
          <aura:if isTrue="{!v.lead.Product__r.Debt_To_Income_Maximum__c != null}">
            , Max DTI: <lightning:formattedNumber value="{!v.lead.Product__r.Debt_To_Income_Maximum__c/100}"
                                                  style="percent"/>
          </aura:if>)
        </div>
      </aura:if>
    </div>
  </div>
  
  <div class="slds-p-top_small">
    <div class="slds-grid slds-wrap slds-grid--vertical-stretch">
      <div class = "darkCell slds-col slds-size--1-of-1">
        <strong>Avidia Review Status:
          <ui:inputSelect aura:id="AvidiaReviewStatus" 
                          value="{!v.lead.Personal_Credit_Report__r.Avidia_Review_Status__c}" 
                          required="true" 
                          change="{!c.updateReviewStatus}"/>
        </strong>
      </div>
    </div>
    <div class="slds-grid slds-wrap slds-grid--vertical-stretch">
      <div class = "lightCell slds-col slds-size--1-of-6">
        Loan Amount:
        <br></br>
        <ui:outputCurrency value="{!v.lead.Requested_Loan_Amount__c}"/>
      </div>
      <div class = "lightCell slds-col slds-size--1-of-6">
        Payment Amount:
        <br></br>
        <ui:outputCurrency value="{!v.lead.Monthly_Payment__c}"/>
      </div>
      <div class = "lightCell slds-col slds-size--1-of-6">
        System Cost:
        <br></br>
        <ui:outputCurrency value="{!v.lead.System_Cost__c}"/>
      </div>
      <div class = "lightCell slds-col slds-size--1-of-6">
        <aura:if isTrue="{!v.hasCoApp}">
          Max FICO:
          <aura:set attribute="else">FICO:</aura:set>
        </aura:if>
        <br></br>
        <ui:outputText value="{!v.bestFICO}"/>
      </div>
      <div class = "lightCell slds-col slds-size--1-of-6">
        <aura:if isTrue="{!v.hasCoApp}">
          Combined DTI After:
          <aura:set attribute="else">DTI After:</aura:set>
        </aura:if>
        <br></br>
        <aura:if isTrue="{!v.bestDTI != null}">
          <lightning:formattedNumber value="{!v.bestDTI/100}"
                                     style="percent" 
                                     maximumFractionDigits="2"/>
        </aura:if>
      </div>
      <div class = "lightCell slds-col slds-size--1-of-6">
        <aura:if isTrue="{!v.hasCoApp}">
          Combined Income:
          <aura:set attribute="else">Income:</aura:set>
        </aura:if>
        <br></br>
        <ui:outputCurrency value="{!v.combinedIncome}"/>
      </div>
    </div>
  </div>

  <div class="slds-p-top_small">
    <aura:if isTrue="{!v.hasCoApp}">
      <div class="slds-grid slds-wrap">
        <div class="slds-col slds-align--absolute-center slds-text-color_inverse">
          <b>Main Applicant: <ui:outputText value="{!v.lead.Name}"/></b>
        </div>
        <div class="slds-col slds-align--absolute-center slds-text-color_inverse">
          <b>Co-Applicant: 
            <ui:outputText value="{!v.lead.Co_Applicant_First_Name__c}"/>&nbsp;
            <ui:outputText value="{!v.lead.Co_Applicant_Last_Name__c}"/></b>
        </div>
      </div>
    </aura:if>

    <!-- CREDIT -->
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class = "slds-border_bottom slds-align_absolute-center slds-size_1-of-1 slds-text-color_inverse">
          <b>Credit</b>
      </div>
    </div>
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class="slds-col slds-size--1-of-2 slds-p-right_small">
        <c:LoanUnderwritingApplicantCredit lead="{!v.lead}" 
                                           isCoApp="false"
                                           pcr="{!v.lead.Personal_Credit_Report__r}" 
                                           attachment="{!v.mainPCRAttachment}" 
                                           objectName="Personal_Credit_Report__r"/>
      </div>
      <aura:if isTrue="{!v.hasCoApp}">
        <div class="slds-col slds-size--1-of-2 slds-p-left_small">
          <c:LoanUnderwritingApplicantCredit lead="{!v.lead}"
                                             isCoApp="true"
                                             pcr="{!v.lead.Personal_Credit_Report_Co_Applicant__r}" 
                                             attachment="{!v.coAppPCRAttachment}" 
                                             objectName="Personal_Credit_Report_Co_Applicant__r"/>
        </div>
      </aura:if>
    </div>

    <!-- DTI -->
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class = "slds-border_bottom slds-align_absolute-center slds-size_1-of-1 slds-text-color_inverse">
          <b>DTI</b>
      </div>
    </div>
    <div class="slds-grid slds-wrap slds-p-top_small slds-grid_align-center">
      <div>
        <div class = "slds-grid slds-wrap slds-grid--vertical-stretch">
          <div class = "lightCell slds-col slds-size--1-of-1">
            <aura:if isTrue="{!v.hasCoApp}">
              Adjusted Combined DTI After:
              <aura:set attribute="else">Adjusted DTI After:</aura:set>
            </aura:if>
            <br></br>
            <ui:inputNumber value="{!v.lead.Personal_Credit_Report__r.Adjusted_DTI__c}"
                            size="3"
                            change="{!c.updateAdjustedDTI}"/>%
          </div> 
          <div class = "lightCell slds-col slds-size--1-of-1">
            Adjusted DTI After Notes:
            <br></br>
	    <ui:inputText class="slds-size--1-of-1"
                          value="{!v.lead.Personal_Credit_Report__r.Adjusted_DTI_Notes__c}"
                          change="{!c.saveDTINotes}"/>
          </div> 
        </div>
      </div>
    </div>
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class="slds-col slds-size--1-of-2 slds-p-right_small">
        <c:LoanUnderwritingApplicantDTI pcr="{!v.lead.Personal_Credit_Report__r}"/>
      </div>
      <aura:if isTrue="{!v.hasCoApp}">
        <div class="slds-col slds-size--1-of-2 slds-p-left_small">
          <c:LoanUnderwritingApplicantDTI pcr="{!v.lead.Personal_Credit_Report_Co_Applicant__r}"/>
        </div>
      </aura:if>
    </div>

    <!-- DEBT -->
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class = "slds-border_bottom slds-align_absolute-center slds-size_1-of-1 slds-text-color_inverse">
          <b>Debt</b>
      </div>
    </div>
    <aura:if isTrue="{!v.lead != null}">
      <div class="slds-grid slds-wrap slds-p-top_small">
        <div class="slds-col slds-size--1-of-2 slds-p-right_small">
          <c:LoanUnderwritingApplicantDebt pcr="{!v.lead.Personal_Credit_Report__r}"/>
        </div>
        <aura:if isTrue="{!v.hasCoApp}">
          <div class="slds-col slds-size--1-of-2 slds-p-left_small">
            <c:LoanUnderwritingApplicantDebt pcr="{!v.lead.Personal_Credit_Report_Co_Applicant__r}"/>
          </div>
        </aura:if>
      </div>
    </aura:if>

    <!-- INCOME -->
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class = "slds-border_bottom slds-align_absolute-center slds-size_1-of-1 slds-text-color_inverse">
          <b>Income</b>
      </div>
    </div>
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class="slds-col slds-size--1-of-2 slds-p-right_small">
        <c:LoanUnderwritingApplicantIncome lead="{!v.lead}" 
                                           pcr="{!v.lead.Personal_Credit_Report__r}" 
                                           isCoApp="false"/>
      </div>
      <aura:if isTrue="{!v.hasCoApp}">
        <div class="slds-col slds-size--1-of-2 slds-p-left_small">
          <c:LoanUnderwritingApplicantIncome lead="{!v.lead}" 
                                             pcr="{!v.lead.Personal_Credit_Report_Co_Applicant__r}"
                                             isCoApp="true"/>
        </div>
      </aura:if>
    </div>

    <!-- INCOME DOCUMENTATION -->
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class = "slds-border_bottom slds-align_absolute-center slds-size_1-of-1 slds-text-color_inverse">
          <b>Income Documentation</b>
      </div>
    </div>
    <div class="slds-grid slds-wrap slds-p-top_small">
      <div class="slds-col slds-size--1-of-1">
        <table class="slds-table slds-table_striped">
          <tbody>
            <aura:iteration items="{!v.lead.Attachments}" var="attachment" >
              <tr>
                <td>
                  <div>
                    <ui:outputURL value="{!'/servlet/servlet.FileDownload?file=' + attachment.Id}" 
                                  label="{!attachment.Name}" target="_blank"/>
                  </div>
                </td>
              </tr>
            </aura:iteration> 
          </tbody>
        </table>
      </div>
      <div class="slds-col slds-size--1-of-1">
        <lightning:input type="file" label="Attachment" variant="label-hidden" name="file" multiple="true" onchange="{!c.handleFilesChange}"/>
        <div aura:id="uploading" class="notUploading">
    	</div>
      </div>
    </div>
  </div>
</aura:component>
