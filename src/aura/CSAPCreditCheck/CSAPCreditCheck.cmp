<aura:component controller="CSAPController" access="global" extends="c:CSAPParent">
  <aura:attribute name="creditChecked" type="Boolean"/>
  <aura:attribute name="creditStatusText" type="String"/>
  <aura:attribute name="creditStatusPoller" type="Integer"/>
  <aura:attribute name="creditStatusTimeout" type="Integer"/>
  <aura:attribute name="creditStatusTimeoutID" type="Integer"/>
  <aura:attribute name="creditStatusErrorText" type="String"/>
  <aura:attribute name="loading" type="Boolean"/>
  <aura:attribute name="loadingText" type="Boolean"/>
  <aura:attribute name="abbrevStates" type="String[]"/>
  <aura:attribute name="showProgramPicklist" type="Boolean"/>
  <aura:attribute name="productList" type="Object[]"/>
  <aura:attribute name="selectedProduct" type="Object"/>
  <aura:attribute name="ShowDateError" type="Boolean"/>

  <aura:set attribute="STAGENAME" value="NAV_Credit_Check"/>
  <aura:handler event="c:CSAPNavigationEvent" action="{!c.handleNavEvent}"/>

  <aura:if isTrue="{!v.page == 'SSNPage'}">
    <div aria-labelledby="ssnForm">
        <fieldset class="slds-box slds-theme--default slds-contstaainer_center">
        <legend id="ssnForm" class="slds-text-heading--small slds-p-vertical--medium slds-section__title--large slds-align_absolute-center">
          <b class="slds-section__title--large slds-p-horizontal_large"> We need to check that you qualify for Community Solar </b>
        </legend>
        <form class="slds-form--stacked">
          <lightning:layout multipleRows="true">
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6">
              <lightning:helptext
                title="Social Security Number Help Text"
                content="In order to qualify for Community Solar, we need your social security number to check your credit score, to see which solar projects you qualify for. This information is securely stored and we do not disclose it to any outside party."/>
              <lightning:input aura:id="field" name="leadSSN"
                       type="password"
                       label="Social Security Number"
                       value="{!v.lead.LASERCA__SSN__c}"
                       placeholder="XXX-XX-XXXX"
                       pattern="^(\d{3}-?\d{2}-?\d{4}|XXX-XX-XXXX)$"
                       messageWhenPatternMismatch="Please enter your Social Security Number in the format of XXX-XX-XXXX (Ex. 123-45-6789)"
                       required="true"/> 
            </lightning:layoutItem>
          </lightning:layout>
          <lightning:layout multipleRows="true">
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6">
              <div aura:id="birthdateElement">
                <label class="slds-form-element__label">
                  <span class="slds-text-color_error">*</span>
                  Date of Birth
                </label>
                <c:BlueWaveDate value="{!v.lead.LASERCA__Birthdate__c}" required="true"/>
                <!--<aura:method name="BirthDate" action="{!c.confirmBirthDate}"/>-->
                <aura:if isTrue="{!v.ShowDateError}">
                  <div class="slds-text-color_error slds-text-body_small">
                    Please enter birth date in the format 01/01/2000
                  </div>
                </aura:if>
              </div>
            </lightning:layoutItem>
          </lightning:layout>

          <lightning:formattedUrl value="https://bluewavesolar.com/about-us/privacy-policy/" label="Please take a moment to review our Privacy Policy" target="_blank" class="slds-p-around--small "/>

          <lightning:layout multipleRows="true">
            <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12">
              <lightning:input aura:id="field" name="leadPrivacyPolicyAcknowledged"
                       label="I acknowledge BlueWave&apos;s privacy policy and accept its terms."
                       type="checkbox"
                       checked="{!v.lead.Privacy_Policy_Acknowledged__c}"
                       required="true"/> 
            </lightning:layoutItem>
          </lightning:layout>

          <lightning:layout multipleRows="true">
            <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12">
              <lightning:input aura:id="field" name="leadCreditCheckAcknowledged"
                       label="I give BlueWave permission to access my credit history."
                       type="checkbox"
                       checked="{!v.lead.Credit_Check_Acknowledged__c}"
                       required="true"/> 
            </lightning:layoutItem>
          </lightning:layout>


          <lightning:layout multipleRows="true">
            <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12">
              <lightning:input aura:id="field" name="leadUtilityBillAccessAcknowledged"
                       label="I give BlueWave and its affiliates permission to access my energy billing history."
                       type="checkbox"
                       checked="{!v.lead.Utility_Bill_Access_Acknowledged__c}"
                       required="true"/> 
            </lightning:layoutItem>
          </lightning:layout>

          <div class="slds-clearfix slds-p-top_medium">
            <div class="slds-float_left">
            </div>
            <div class="slds-float_right">
              <lightning:button label="Next" onclick="{!c.goToPersonalInfoConfirmation}"/>
            </div>
          </div>
      

        </form>
      </fieldset>
    </div>
  </aura:if>

  <aura:if isTrue="{!v.page == 'PersonalInfoConfirmation'}">
    <div aria-labelledby="informationConfirmationForm">
        <fieldset class="slds-box slds-theme--default slds-container_center">
        <legend id="informationConfirmationForm" class="slds-text-heading--small slds-p-vertical--medium slds-align_absolute-center">
          <b class="slds-section__title--large slds-p-horizontal_large"> Please verify your information is correct before we check your score. </b>
        </legend>

        <form class="slds-form--stacked">
          <lightning:layout multipleRows="true">
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6">
              <lightning:input aura:id="field" name="leadFirstName"
                       label="First Name"
                       value="{!v.lead.FirstName}"
                       required="true"/> 
            </lightning:layoutItem>
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6" >
              <lightning:input aura:id="field" name="leadLastName"
                       label="Last Name"
                       value="{!v.lead.LastName}"
                       required="true"/> 
            </lightning:layoutItem>
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6">
              <lightning:input aura:id="field" name="leadHomeAddress"
                       label="Street Address"
                       value="{!v.lead.LASERCA__Home_Address__c}"
                       required="true"/> 
            </lightning:layoutItem>
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6" >
              <lightning:input aura:id="field" name="leadHomeCity"
                       label="City"
                       value="{!v.lead.LASERCA__Home_City__c}"
                       required="true"/> 
            </lightning:layoutItem>
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6">
              <lightning:select aura:id="field" name="leadHomeState" 
                                label="State" 
                                value="{!v.lead.LASERCA__Home_State__c}"
                                required="true">
                  <option value="">Choose state...</option>
                  <aura:iteration items="{!v.abbrevStates}" var="s">
                      <option value="{!s}" text="{!s}"></option>
                  </aura:iteration>
              </lightning:select>
            </lightning:layoutItem>
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6" >
              <lightning:input aura:id="field" name="leadHomeZip"
                               label="Zip Code"
                               value="{!v.lead.LASERCA__Home_Zip__c}"
                               required="true"/> 
            </lightning:layoutItem>
          </lightning:layout>

          <div class="slds-clearfix slds-p-top_medium">
            <div class="slds-float_left">
              <lightning:button label="Previous" onclick="{!c.goToSSNPage}"/>
            </div>
            <div class="slds-float_right">
              <lightning:button label="Run Credit Check" onclick="{!c.checkCredit}"/>
            </div>
          </div>
      
      

        </form>
      </fieldset>
    </div>
  </aura:if>

  <aura:if isTrue="{!v.page == 'CreditAlreadyRun'}">
    <div class="slds-icon-eq slds-is-animated slds-align_absolute-center" title="Description of the icon when needed">
      <div class="slds-icon-eq__bar"></div>
      <div class="slds-icon-eq__bar"></div>
      <div class="slds-icon-eq__bar"></div>
      <span class="slds-assistive-text">Text alternative when needed</span>
    </div>
    <div class="slds-text-body--regular slds-align_absolute-center">
      Checking if you are qualified for the projects in your area...
    </div>
  </aura:if>

  <aura:if isTrue="{!v.page == 'CreditCheckResult'}">
    <aura:if isTrue="{!!v.creditChecked}">

    <aura:if isTrue="{!v.loading}">
      <div class="slds-icon-eq slds-is-animated slds-align_absolute-center" title="Description of the icon when needed">
        <div class="slds-icon-eq__bar"></div>
        <div class="slds-icon-eq__bar"></div>
        <div class="slds-icon-eq__bar"></div>
        <span class="slds-assistive-text">Text alternative when needed</span>
      </div>
      <div class="slds-text-body--regular slds-align_absolute-center">
        {!v.loadingText}
      </div>
    </aura:if>
      <div class="slds-align--absolute-center slds-p-top_medium slds-text-body--regular slds-align_absolute-center">Pulling credit report... This process may take up to a minute.</div></aura:if>

    <div aura:id="creditStatus" class="slds-align--absolute-center slds-p-top_medium noDisplay slds-text-body--regular slds-align_absolute-center">
      <ui:outputText value="{!v.creditStatusText}"/>
    </div>
    <div aura:id="creditResultError" class="noDisplay center">
      <ui:outputText value="{!'There was an error: ' + v.creditStatusErrorText + ' You can refresh the page and log back into the application to check status or retry the credit check.'}"/>
    </div>

    
    <aura:if isTrue="{!v.creditChecked}">
      <aura:if isTrue="{!v.lead.Status == 'Qualified'}">
        <lightning:layout aura:id="passedCreditText" class="animated" multipleRows="true" horizontalAlign="center">
          <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12">
            <div class="slds-align--absolute-center">
              <p><b class="slds-text-body--xx_large--stream animated">Congratulations!</b></p>
            </div>
          </lightning:layoutItem>
          <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12">
            <div class="slds-align--absolute-center">
              <p><b class="slds-text-body--large--blue">You qualify for Community Solar in your area! </b></p>
            </div>
          </lightning:layoutItem>
        </lightning:layout>
        <lightning:layout aura:id="passedCreditText" class="animated" multipleRows="true" horizontalAlign="center">
          <aura:if isTrue="{!v.showProgramPicklist}">
            <lightning:layoutItem padding="around-small" size="6" smallDeviceSize="12" mediumDeviceSize="6">
              <lightning:select  aura:id="field" name="programPicklist"
                                 label="Which Community Solar program would you like to apply for?"
                                 value="{!v.lead.Product__c}">
                <option value="" text="Select"></option>
                <aura:iteration items="{!v.productList}" var="productToChoose">
                  <option value="{!productToChoose.Id}" text="{!productToChoose.Program__c}"></option>
                </aura:iteration>
              </lightning:select>
            </lightning:layoutItem>
          </aura:if>
            <aura:if isTrue="{!or(not(v.showProgramPicklist), and(v.showProgramPicklist, not(empty(v.lead.Product__c))))}">
            <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12" >
              <div class="slds-align--absolute-center">
                <lightning:button label="Continue" onclick="{!c.finishStage}"/>
              </div>
            </lightning:layoutItem>
          </aura:if>
        </lightning:layout>
      </aura:if>
      <aura:if isTrue="{!v.lead.Status == 'Unqualified'}">
        <lightning:layout multipleRows="true" horizontalAlign="center">
          <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12">
            <div class="slds-align--absolute-center slds-text-body--large--blue">
              <b>Unfortunately, you don't qualify for Community Solar in your area.</b>
            </div>
          </lightning:layoutItem>
          <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12" >
            <div class="slds-align--absolute-center slds-text-body--large--blue">
              <b>Please feel free to reach out to our customer support team listed below if you have any questions!</b>
            </div>
          </lightning:layoutItem>
          <lightning:layoutItem padding="around-small" size="12" smallDeviceSize="12" mediumDeviceSize="12" >
            <div class="slds-align--absolute-center">
              <b>You may now close this application.</b>
            </div>
          </lightning:layoutItem>
        </lightning:layout>
      </aura:if>
    </aura:if>
  </aura:if>
</aura:component>