<aura:component implements="forceCommunity:availableForAllPageTypes,force:hasRecordId" controller="ZuoraPaymentPageController">
  <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
  <aura:handler event="c:ZuoraPaymentPageComplete" action="{!c.onPaymentMethodChange}"/>

  <aura:attribute name="showCardPaymentAmount" type="Boolean" default="false"/>
  <aura:attribute name="showCardPaymentMethod" type="Boolean" default="false"/>
  <aura:attribute name="showCardAutopay" type="Boolean" default="false"/>
  <aura:attribute name="showEnabledButton" type="Boolean" default="false"/>
  <aura:attribute name="showSpinner" type="Boolean" default="true"/>
  <aura:attribute name="showAutopaySection" type="Boolean" default="true"/>
  <aura:attribute name="showPostSubmitPage" type="Boolean" default="false"/>
  <aura:attribute name="zuoraIsLoading" type="Boolean" default="false"/>

  <aura:attribute name="zuoraAccountAndPayMethod" type="Object"/>
  <aura:attribute name="makePaymentOrManageAutopay" type="Boolean" default="true"/>
  <aura:attribute name="autopayAsText" type="String"/>
  <aura:attribute name="newAutopaySelection" type="Boolean"/>
  <aura:attribute name="forceAutopaySelection" type="Boolean"/>
  <aura:attribute name="AutopayAgree" type="Boolean" default="false"/>
  <aura:attribute name="AgreeButtonOptions" type="List" default="[{'label': 'I Agree', 'value': true}]"/>
  <aura:attribute name="customChargeAmount" type="Decimal" default="0"/>
  <aura:attribute name="customPaymentAmountMessage" type="String" default=""/>
  <aura:attribute name="paymentAmount" type="Decimal"/>
  <aura:attribute name="balanceSelection" type="String" default="fullBalance"/>
  <aura:attribute name="RadioOptions" type="List" default="[
        {'label': 'Full Balance $$', 'value': 'fullBalance'},
        {'label': 'Other', 'value': 'customAmount'}]"/>
  <aura:attribute name="newPaymentMethodType" type="String"/>
  <aura:attribute name="userSelectedPaymentMethod" type="String"/>
  <aura:attribute name="currentPaymentMethod" type="String"/>
  <aura:attribute name="newPaymentMethodId" type="String"/>
  <aura:attribute name="showNewPaymentMethodInstruction" type="Boolean" default="false"/>
  <aura:attribute name="missingFieldsMessage" type="String" default="Please complete all required fields to continue"/>
  <aura:attribute name="responseMessage" type="String"/>
  <aura:attribute name="sfAccountId" type="String"/>
  <aura:attribute name="outstandingItemsByDate" type="Object"/>
  <aura:attribute name="companyName" type="String" default="{!$Label.c.Company_Name}"/>
  <aura:attribute name="customerCareEmail" type="String" default="{!$Label.c.email_customercare}"/>

  <aura:handler name="change" value="{!v.outstandingItemsByDate}" action="{!c.checkAllRequiredFields}"/>

  <aura:if isTrue="{!$Browser.isPhone}">
    <article class="">
      <aura:if isTrue="{!v.showSpinner}">
        <lightning:spinner alternativeText="Loading..." size="medium"/>
        <aura:set attribute="else">
          <aura:if isTrue="{!v.showPostSubmitPage}">
            <div class="slds-text-heading_small slds-align_absolute-center slds-p-around--large">
              <b>{!v.responseMessage}</b>
            </div>
            <div class="slds-align_absolute-center">
              <lightning:button aura:id="done"
                                name="done"
                                onclick="{!c.returnToMyAccount}"
                                label="Done, Return to My Account"
                                class="slds-text-body_small slds-button--brand
                                     slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
            </div>
            <aura:set attribute="else">
              <aura:if isTrue="{!v.showAutopaySection}">
                <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                  <div class="slds-col slds-size_12-of-12 slds-theme_offline slds-p-around_small">
                    <aura:if isTrue="{!v.showCardAutopay}">
                      <lightning:buttonIcon
                        iconName="utility:chevrondown"
                        size="medium"
                        variant="bare-inverse"
                        class="slds-p-right_small"
                        onclick="{!c.toggleCardAutopay}"/>
                      <aura:set attribute="else">
                        <lightning:buttonIcon
                          iconName="utility:chevronright"
                          size="medium"
                          variant="bare-inverse"
                          class="slds-p-right_small"
                          onclick="{!c.toggleCardAutopay}"/>
                      </aura:set>
                    </aura:if>
                    <span class="slds-p-around_small">
                      <lightning:buttonIcon
                        iconName="utility:date_time"
                        size="large"
                        variant="bare-inverse"
                        onclick="{!c.toggleCardAutopay}"/>
                      <span class="slds-p-left_large slds-text-body_small">
                        <strong>Autopay: </strong>
                        <aura:if isTrue="{!v.forceAutopaySelection}">
                          <i>Manage</i>
                          <aura:set attribute="else">
                            <i>{!v.newAutopaySelection ? 'ON' : 'OFF'}</i>
                          </aura:set>
                        </aura:if>
                      </span>
                    </span>
                  </div>
                </div>
                <aura:if isTrue="{!v.showCardAutopay}">
                  <div class="slds-p-bottom_large">
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_12-of-12">
                        <div aura:id="mustAgree" class="slds-form-element slds-size_1-of-1 slds-large-size_2-of-2 slds-p-top_medium slds-p-bottom_medium">
                          <label><b>{!v.zuoraAccountAndPayMethod.account.AutoPay ? 'Do you want to be enrolled in autopay?' : 'Do you want to enroll in autopay?'}</b></label>
                          <ui:inputSelect aura:id="autopayOption"
                                          class="slds-input"
                                          value="{!v.autopayAsText}"
                                          change="{!c.onAutopayChange}">
                            <aura:if isTrue="{!v.forceAutopaySelection}">
                              <ui:inputSelectOption label="Select" text="Select"/>
                            </aura:if>
                            <ui:inputSelectOption label="Yes" text="Yes"/>
                            <ui:inputSelectOption label="No" text="No"/>
                          </ui:inputSelect>
                        </div>
                        <aura:if isTrue="{!v.autopayAsText == 'Yes'}">
                          <div class="slds-p-top_medium slds-p-bottom_medium">
                            <fieldset class="slds-box slds-theme--default slds-p-top_medium slds-container--medium slds-p-top_medium">
                              <div class="slds-text-body_small slds-text-color_default">
                                I hereby authorize {!v.companyName} or its servicer(s) to initiate debit entries (ACH) on my bank account
                                or automatically charge the credit card I designate in this form. I understand that any debit entry
                                from my account that is returned unpaid may be collected in the same manner as an unpaid paper check.
                                I understand that the monthly payment amount debited from my bank account may vary from month to
                                month based on variable generation from my Shared Solar System.
                                My authorization for debit entries to my designated bank account shall remain in full force
                                and effect until {!v.companyName} or its servicer(s) has received written notification from me at
                                least thirty (30) days in advance of my intent to change or cancel this Authorization for
                                pre-arranged payments. I hereby release {!v.companyName} or its servicer(s) from any and all claims
                                resulting from this authorization.
                              </div>
                              <div class="slds-p-top_medium">
                                <h3 class="slds-text-body_small slds-text-color_default">
                                  <aura:if isTrue="{!v.AutopayAgree}">
                                    <i><b>Agreed</b></i>
                                    <aura:set attribute="else">
                                      <lightning:button aura:id="autopayAgree"
                                                        name="autopayAgree"
                                                        label="I Agree"
                                                        onclick="{!c.agreeToAutopay}"
                                                        class="slds-text-body_small slds-button--brand
                                                            slds-p-left_small slds-p-right_small"/>
                                    </aura:set>
                                  </aura:if>
                                </h3>
                              </div>
                            </fieldset>
                          </div>
                        </aura:if>
                      </div>
                    </div>
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_12-of-12">
                        <lightning:button aura:id="nextPageAutopay"
                                          name="nextPageAutopay"
                                          label="Next"
                                          onclick="{!c.closeAutopayOpenAmount}"
                                          class="slds-text-body_small slds-button--brand slds-float_right
                                                   slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                      </div>
                    </div>
                  </div>
                </aura:if>
              </aura:if>

              <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                  <div class="slds-col slds-size_12-of-12 slds-theme_offline slds-p-around_small">
                    <aura:if isTrue="{!v.showCardPaymentAmount}">
                      <lightning:buttonIcon
                        iconName="utility:chevrondown"
                        size="medium"
                        variant="bare-inverse"
                        class="slds-p-right_small"
                        onclick="{!c.toggleCardPaymentAmount}"/>
                      <aura:set attribute="else">
                        <lightning:buttonIcon
                          iconName="utility:chevronright"
                          size="medium"
                          variant="bare-inverse"
                          class="slds-p-right_small"
                          onclick="{!c.toggleCardPaymentAmount}"/>
                      </aura:set>
                    </aura:if>
                    <span class="slds-p-around_small">
                      <lightning:buttonIcon
                        iconName="utility:money"
                        size="large"
                        variant="bare-inverse"
                        onclick="{!c.toggleCardPaymentAmount}"/>
                      <span class="slds-p-left_large slds-text-body_small">
                        <strong>Amount: </strong>
                        <i><ui:outputCurrency value="{!v.paymentAmount}"/></i>
                      </span>
                    </span>
                  </div>
                </div>
                <aura:if isTrue="{!v.showCardPaymentAmount}">
                  <div class="slds-p-bottom_large">
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_12-of-12">
                        <div class="slds-p-top_medium slds-p-bottom_medium">
                          <lightning:radioGroup aura:id ="radioButtonPaymentAmount"
                                                options="{!v.RadioOptions}"
                                                onchange="{!c.onToggleFullBalance}"
                                                value="{!v.balanceSelection}"
                                                type="radio"/>
                          <lightning:input type="number"
                                           formatter="currency"
                                           step="0.01"
                                           value="{!v.customChargeAmount}"
                                           onchange="{!c.onPaymentAmountChange}"/>
                          <ui:outputText value="{!v.customPaymentAmountMessage}"/>
                        </div>
                      </div>
                    </div>
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_12-of-12">
                        <lightning:button aura:id="nextPagePayAmount"
                                          name="nextPagePayAmount"
                                          label="Next"
                                          onclick="{!c.closeAmountOpenMethod}"
                                          class="slds-text-body_small slds-button--brand slds-float_right
                                                 slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                      </div>
                    </div>
                  </div>
                </aura:if>
              </aura:if>
              <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                <div class="slds-col slds-size_12-of-12 slds-theme_offline slds-p-around_small">
                  <aura:if isTrue="{!v.showCardPaymentMethod}">
                    <lightning:buttonIcon
                      iconName="utility:chevrondown"
                      size="medium"
                      variant="bare-inverse"
                      class="slds-p-right_small"
                      onclick="{!c.toggleCardPaymentMethod}"/>
                    <aura:set attribute="else">
                      <lightning:buttonIcon
                        iconName="utility:chevronright"
                        size="medium"
                        variant="bare-inverse"
                        class="slds-p-right_small"
                        onclick="{!c.toggleCardPaymentMethod}"/>
                    </aura:set>
                  </aura:if>
                  <span class="slds-p-around_small">
                    <lightning:buttonIcon
                      iconName="utility:identity"
                      size="large"
                      variant="bare-inverse"
                      onclick="{!c.toggleCardPaymentMethod}"/>
                    <span class="slds-p-left_large slds-text-body_small">
                      <strong>Method: </strong>
                      <i><ui:outputText value="{!v.currentPaymentMethod}"/></i>
                    </span>
                  </span>
                </div>
              </div>
              <aura:if isTrue="{!v.showCardPaymentMethod}">
                <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                  <div class="slds-col slds-size_12-of-12">
                    <div class="slds-form-element slds-size_1-of-1 slds-large-size_2-of-2 slds-p-top_medium slds-p-bottom_medium">
                      <ui:inputSelect class="slds-input"
                                      value="{!v.userSelectedPaymentMethod}"
                                      change="{!c.onPaymentMethodTypeChange}">
                        <ui:inputSelectOption
                          label="{!v.zuoraAccountAndPayMethod.account.AutoPay ? 'Use existing payment method' : 'Add a new Payment Method'}"
                          text=""/>
                        <ui:inputSelectOption label="Add a new Bank Account" text="ACH"/>
                        <ui:inputSelectOption label="Add a new Credit Card" text="Credit Card"/>
                      </ui:inputSelect>
                    </div>
                    <aura:if isTrue="{!v.zuoraIsLoading}">
                      Loading...
                    </aura:if>
                    <div class="slds-p-top_medium slds-p-bottom_medium">
                      <c:ZuoraPaymentPage paymentType="{!v.newPaymentMethodType}" zuoraAccountId="{!v.zuoraAccountAndPayMethod.account.Id}"/>
                      <aura:if isTrue="{!or(v.userSelectedPaymentMethod == 'ACH', v.userSelectedPaymentMethod == 'Credit Card')}">
                        <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                          <div class="slds-text-color_error">
                            To complete your payment, please enter your payment information, click "Submit Securely" to verify the payment method, and then click "Make A Payment" to complete the transaction. You must click these buttons in that order to successfully complete a payment.
                          </div>
                          <div class="slds-text-color_error">
                            Please do not hit the back button on your browser while the payment is processing.
                          </div>
                          <aura:set attribute="else">
                            <div class="slds-text-color_error">
                              To change your autopay payment method, please enter your payment information, click "Submit Securely" to verify the payment method, and then click "Update Account". You must click these buttons in that order to successfully change your autopay method.
                            </div>
                          </aura:set>
                        </aura:if>
                      </aura:if>
                    </div>
                  </div>
                </div>
              </aura:if>
              <div class="slds-p-top_large"></div>
              <aura:if isTrue="{!v.showNewPaymentMethodInstruction}">
                <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                  <div class="slds-text-color_error slds-p-bottom_medium">
                    We've verified your payment method, please click "Make A Payment" to complete the transaction. If you do not click Make A Payment, we will not process your transaction.
                  </div>
                  <aura:set attribute="else">
                    <div class="slds-text-color_error slds-p-bottom_medium">
                      <div class="slds-p-bottom_small">
                        We've verified your payment method, please click "Update Account" to use this payment method during the next autopay run.
                      </div>
                      <div>
                        To make a one-time payment now, please click "Update Account" and then use the "Make A Payment" button.
                      </div>
                    </div>
                  </aura:set>
                </aura:if>
              </aura:if>
              <aura:if isTrue="{!v.showEnabledButton}">
                <div class="slds-align_absolute-center">
                  <lightning:button aura:id="makeAPayment"
                                    name="makeAPayment"
                                    onclick="{!c.sendToZuora}"
                                    label="{!v.makePaymentOrManageAutopay ? 'Make A Payment' : 'Update Account'}"
                                    class="slds-text-body_small slds-button--brand
                                           slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                </div>
                <aura:set attribute="else">
                  <div class="slds-align_absolute-center">
                    <lightning:button aura:id="makeAPayment"
                                      name="makeAPayment"
                                      label="{!v.makePaymentOrManageAutopay ? 'Make A Payment' : 'Update Account'}"
                                      disabled="true"
                                      class="slds-text-body_small slds-theme_shade slds-theme_alert-texture
                                           slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                  </div>
                </aura:set>
              </aura:if>
              <div class="slds-align_absolute-center slds-p-top_small">
                <aura:if isTrue="{!!v.showEnabledButton}">
                  <div>
                    <i><ui:outputText value="{!v.missingFieldsMessage}"/></i>
                  </div>
                </aura:if>
              </div>
              <div class="slds-align_absolute-center slds-p-top_small">
                <lightning:button aura:id="goBack"
                                  name="acknowledgePayment"
                                  label="Cancel"
                                  onclick="{!c.returnToMyAccount}"
                                  class="slds-text-body_small
                                      slds-p-top_x-small slds-p-bottom_x-small slds-p-left_small slds-p-right_small"/>
              </div>

              <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                <div class="slds-text-body_small slds-text-color_error slds-p-top_medium">
                  Do not reload page after submission or re-submit payment unless instructed to do so. If you are unsure whether the payment was accepted, please contact {!v.companyName} customer care.
                </div>
                <div class="slds-text-body_small slds-text-color_default slds-p-top_medium">
                  By clicking the button, you agree to allow {!v.companyName} to split the total payment value into multiple transactions. If your account is subscribed to more than one solar project each subscription will be billed separately but never more than the total payment shown above. If you would like a detailed list of transactions, please see the paper bill that was emailed to you or reach out to {!v.companyName} at {!v.customerCareEmail}.
                </div>
              </aura:if>
            </aura:set>
          </aura:if>
        </aura:set>
      </aura:if>
    </article>
    <aura:set attribute="else">
      <article class="">
        <div class="slds-p-left_x-large slds-p-right_x-large">
          <aura:if isTrue="{!v.showSpinner}">
            <lightning:spinner alternativeText="Loading..." size="medium"/>
            <aura:set attribute="else">
              <aura:if isTrue="{!v.showPostSubmitPage}">
                <div class="slds-text-heading_small slds-align_absolute-center slds-p-around--large">
                  <b>{!v.responseMessage}</b>
                </div>
                <div class="slds-align_absolute-center">
                  <lightning:button aura:id="done"
                                    name="done"
                                    onclick="{!c.returnToMyAccount}"
                                    label="Done, Return to My Account"
                                    class="slds-text-body_small slds-button--brand
                                     slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                </div>
                <aura:set attribute="else">
                  <aura:if isTrue="{!v.showAutopaySection}">
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_12-of-12 slds-theme_offline slds-p-around_small">
                        <aura:if isTrue="{!v.showCardAutopay}">
                          <lightning:buttonIcon
                            iconName="utility:chevrondown"
                            size="medium"
                            variant="bare-inverse"
                            class="slds-p-right_small"
                            onclick="{!c.toggleCardAutopay}"/>
                          <aura:set attribute="else">
                            <lightning:buttonIcon
                              iconName="utility:chevronright"
                              size="medium"
                              variant="bare-inverse"
                              class="slds-p-right_small"
                              onclick="{!c.toggleCardAutopay}"/>
                          </aura:set>
                        </aura:if>
                        <span class="slds-p-around_small">
                      <lightning:buttonIcon
                        iconName="utility:date_time"
                        size="large"
                        variant="bare-inverse"
                        onclick="{!c.toggleCardAutopay}"/>
                      <span class="slds-p-left_large slds-text-heading_small">
                        <strong>Autopay: </strong>
                        <aura:if isTrue="{!v.forceAutopaySelection}">
                          <i>Manage</i>
                          <aura:set attribute="else">
                            <i>{!v.newAutopaySelection ? 'ON' : 'OFF'}</i>
                          </aura:set>
                        </aura:if>
                      </span>
                    </span>
                      </div>
                    </div>
                    <aura:if isTrue="{!v.showCardAutopay}">
                      <div class="slds-p-bottom_large">
                        <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                          <div class="slds-col slds-size_1-of-12"/>
                          <div class="slds-col slds-size_7-of-12">
                            <div aura:id="mustAgree" class="slds-form-element slds-size_1-of-1 slds-large-size_2-of-2 slds-p-top_medium slds-p-bottom_medium">
                              <label><b>{!v.zuoraAccountAndPayMethod.account.AutoPay ? 'Do you want to be enrolled in autopay?' : 'Do you want to enroll in autopay?'}</b></label>
                              <ui:inputSelect aura:id="autopayOption"
                                              class="slds-input"
                                              value="{!v.autopayAsText}"
                                              change="{!c.onAutopayChange}">
                                <aura:if isTrue="{!v.forceAutopaySelection}">
                                  <ui:inputSelectOption label="Select" text="Select"/>
                                </aura:if>
                                <ui:inputSelectOption label="Yes" text="Yes"/>
                                <ui:inputSelectOption label="No" text="No"/>
                              </ui:inputSelect>
                            </div>
                            <aura:if isTrue="{!v.autopayAsText == 'Yes'}">
                              <div class="slds-p-top_medium slds-p-bottom_medium">
                                <fieldset class="slds-box slds-theme--default slds-p-top_medium slds-container--medium slds-p-top_medium">
                                  <div class="slds-p-left_small slds-p-right_small">
                                    <div class="slds-text-body_small slds-text-color_default">
                                      I hereby authorize {!v.companyName} or its servicer(s) to initiate debit entries (ACH) on my bank account
                                      or automatically charge the credit card I designate in this form. I understand that any debit entry
                                      from my account that is returned unpaid may be collected in the same manner as an unpaid paper check.
                                      I understand that the monthly payment amount debited from my bank account may vary from month to
                                      month based on variable generation from my Shared Solar System.
                                      My authorization for debit entries to my designated bank account shall remain in full force
                                      and effect until {!v.companyName} or its servicer(s) has received written notification from me at
                                      least thirty (30) days in advance of my intent to change or cancel this Authorization for
                                      pre-arranged payments. I hereby release {!v.companyName} or its servicer(s) from any and all claims
                                      resulting from this authorization.
                                    </div>
                                    <div class="slds-p-top_medium">
                                      <h3 class="slds-text-body_small slds-text-color_default">
                                        <aura:if isTrue="{!v.AutopayAgree}">
                                          <i><b>Agreed</b></i>
                                          <aura:set attribute="else">
                                            <lightning:button aura:id="autopayAgree"
                                                              name="autopayAgree"
                                                              label="I Agree"
                                                              onclick="{!c.agreeToAutopay}"
                                                              class="slds-text-body_small slds-button--brand
                                                            slds-p-left_small slds-p-right_small"/>
                                          </aura:set>
                                        </aura:if>
                                      </h3>
                                    </div>
                                  </div>
                                </fieldset>
                              </div>
                            </aura:if>
                          </div>
                          <div class="slds-col slds-size_4-of-12"/>
                        </div>
                        <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                          <div class="slds-col slds-size_1-of-12"/>
                          <div class="slds-col slds-size_7-of-12">
                            <lightning:button aura:id="nextPageAutopay"
                                              name="nextPageAutopay"
                                              label="Next"
                                              onclick="{!c.closeAutopayOpenAmount}"
                                              class="slds-text-body_small slds-button--brand slds-float_right
                                                   slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                          </div>
                        </div>
                      </div>
                    </aura:if>
                  </aura:if>

                  <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_12-of-12 slds-theme_offline slds-p-around_small">
                        <aura:if isTrue="{!v.showCardPaymentAmount}">
                          <lightning:buttonIcon
                            iconName="utility:chevrondown"
                            size="medium"
                            variant="bare-inverse"
                            class="slds-p-right_small"
                            onclick="{!c.toggleCardPaymentAmount}"/>
                          <aura:set attribute="else">
                            <lightning:buttonIcon
                              iconName="utility:chevronright"
                              size="medium"
                              variant="bare-inverse"
                              class="slds-p-right_small"
                              onclick="{!c.toggleCardPaymentAmount}"/>
                          </aura:set>
                        </aura:if>
                        <span class="slds-p-around_small">
                      <lightning:buttonIcon
                        iconName="utility:money"
                        size="large"
                        variant="bare-inverse"
                        onclick="{!c.toggleCardPaymentAmount}"/>
                      <span class="slds-p-left_large slds-text-heading_small">
                        <strong>Payment Amount: </strong>
                        <i><ui:outputCurrency value="{!v.paymentAmount}"/></i>
                      </span>
                    </span>
                      </div>
                    </div>
                    <aura:if isTrue="{!v.showCardPaymentAmount}">
                      <div class="slds-p-bottom_large">
                        <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                          <div class="slds-col slds-size_1-of-12"/>
                          <div class="slds-col slds-size_7-of-12">
                            <div class="slds-p-top_medium slds-p-bottom_medium">
                              <lightning:radioGroup aura:id ="radioButtonPaymentAmount"
                                                    options="{!v.RadioOptions}"
                                                    onchange="{!c.onToggleFullBalance}"
                                                    value="{!v.balanceSelection}"
                                                    type="radio"/>
                              <lightning:input type="number"
                                               formatter="currency"
                                               step="0.01"
                                               value="{!v.customChargeAmount}"
                                               onchange="{!c.onPaymentAmountChange}"/>
                              <ui:outputText value="{!v.customPaymentAmountMessage}"/>
                            </div>
                          </div>
                          <div class="slds-col slds-size_4-of-12"/>
                        </div>
                        <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                          <div class="slds-col slds-size_1-of-12"/>
                          <div class="slds-col slds-size_7-of-12">
                            <lightning:button aura:id="nextPagePayAmount"
                                              name="nextPagePayAmount"
                                              label="Next"
                                              onclick="{!c.closeAmountOpenMethod}"
                                              class="slds-text-body_small slds-button--brand slds-float_right
                                                 slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                          </div>
                        </div>
                      </div>
                    </aura:if>
                  </aura:if>
                  <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                    <div class="slds-col slds-size_12-of-12 slds-theme_offline slds-p-around_small">
                      <aura:if isTrue="{!v.showCardPaymentMethod}">
                        <lightning:buttonIcon
                          iconName="utility:chevrondown"
                          size="medium"
                          variant="bare-inverse"
                          class="slds-p-right_small"
                          onclick="{!c.toggleCardPaymentMethod}"/>
                        <aura:set attribute="else">
                          <lightning:buttonIcon
                            iconName="utility:chevronright"
                            size="medium"
                            variant="bare-inverse"
                            class="slds-p-right_small"
                            onclick="{!c.toggleCardPaymentMethod}"/>
                        </aura:set>
                      </aura:if>
                      <span class="slds-p-around_small">
                    <lightning:buttonIcon
                      iconName="utility:identity"
                      size="large"
                      variant="bare-inverse"
                      onclick="{!c.toggleCardPaymentMethod}"/>
                    <span class="slds-p-left_large slds-text-heading_small">
                      <strong>Payment Method: </strong>
                      <i><ui:outputText value="{!v.currentPaymentMethod}"/></i>
                    </span>
                  </span>
                    </div>
                  </div>
                  <aura:if isTrue="{!v.showCardPaymentMethod}">
                    <div class="slds-grid slds-gutters slds-grid_vertical-align-start">
                      <div class="slds-col slds-size_1-of-12 slds-theme_offline"/>
                      <div class="slds-col slds-size_7-of-12">
                        <div class="slds-form-element slds-size_1-of-1 slds-large-size_2-of-2 slds-p-top_medium slds-p-bottom_medium">
                          <ui:inputSelect class="slds-input"
                                          value="{!v.userSelectedPaymentMethod}"
                                          change="{!c.onPaymentMethodTypeChange}">
                            <ui:inputSelectOption
                              label="{!v.zuoraAccountAndPayMethod.account.AutoPay ? 'Use existing payment method' : 'Add a new Payment Method'}"
                              text=""/>
                            <ui:inputSelectOption label="Add a new Bank Account" text="ACH"/>
                            <ui:inputSelectOption label="Add a new Credit Card" text="Credit Card"/>
                          </ui:inputSelect>
                        </div>
                        <aura:if isTrue="{!v.zuoraIsLoading}">
                          Loading...
                        </aura:if>
                        <div class="slds-p-top_medium">
                          <c:ZuoraPaymentPage paymentType="{!v.newPaymentMethodType}" zuoraAccountId="{!v.zuoraAccountAndPayMethod.account.Id}"/>
                          <aura:if isTrue="{!or(v.userSelectedPaymentMethod == 'ACH', v.userSelectedPaymentMethod == 'Credit Card')}">
                            <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                              <div class="slds-text-color_error">
                                To complete your payment, please enter your payment information, click "Submit Securely" to verify the payment method, and then click "Make A Payment" to complete the transaction. You must click these buttons in that order to successfully complete a payment.
                              </div>
                              <div class="slds-text-color_error">
                                Please do not hit the back button on your browser while the payment is processing.
                              </div>
                              <aura:set attribute="else">
                                <div class="slds-text-color_error">
                                  To change your autopay payment method, please enter your payment information, click "Submit Securely" to verify the payment method, and then click "Update Account". You must click these buttons in that order to successfully change your autopay method.
                                </div>
                              </aura:set>
                            </aura:if>
                          </aura:if>
                        </div>
                      </div>
                    </div>
                  </aura:if>
                  <div class="slds-p-top_large"></div>
                  <aura:if isTrue="{!v.showNewPaymentMethodInstruction}">
                    <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                      <div class="slds-text-color_error slds-p-bottom_medium">
                        We've verified your payment method, please click "Make A Payment" to complete the transaction. If you do not click Make A Payment, we will not process your transaction.
                      </div>
                      <aura:set attribute="else">
                        <div class="slds-text-color_error slds-p-bottom_medium">
                          <div class="slds-p-bottom_small">
                            We've verified your payment method, please click "Update Account" to use this payment method during the next autopay run.
                          </div>
                          <div>
                            To make a one-time payment now, please click "Update Account" and then use the "Make A Payment" button.
                          </div>
                        </div>
                      </aura:set>
                    </aura:if>
                  </aura:if>
                  <aura:if isTrue="{!v.showEnabledButton}">
                    <lightning:button aura:id="makeAPayment"
                                      name="makeAPayment"
                                      onclick="{!c.sendToZuora}"
                                      label="{!v.makePaymentOrManageAutopay ? 'Make A Payment' : 'Update Account'}"
                                      class="slds-text-body_small slds-button--brand
                                         slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                    <aura:set attribute="else">
                      <lightning:button aura:id="makeAPayment"
                                        name="makeAPayment"
                                        label="{!v.makePaymentOrManageAutopay ? 'Make A Payment' : 'Update Account'}"
                                        disabled="true"
                                        class="slds-text-body_small slds-theme_shade slds-theme_alert-texture
                                         slds-p-top_x-small slds-p-bottom_x-small slds-p-left_xx-large slds-p-right_xx-large"/>
                    </aura:set>
                  </aura:if>
                  <lightning:button aura:id="goBack"
                                    name="acknowledgePayment"
                                    label="Cancel"
                                    onclick="{!c.returnToMyAccount}"
                                    class="slds-text-body_small
                                      slds-p-top_x-small slds-p-bottom_x-small slds-p-left_small slds-p-right_small"/>
                  <aura:if isTrue="{!!v.showEnabledButton}">
                    <div>
                      <i><ui:outputText value="{!v.missingFieldsMessage}"/></i>
                    </div>
                  </aura:if>
                  <aura:if isTrue="{!v.makePaymentOrManageAutopay}">
                    <div class="slds-text-body_small slds-text-color_error slds-p-top_medium">
                      Do not reload page after submission or re-submit payment unless instructed to do so. If you are unsure whether the payment was accepted, please contact {!v.companyName} customer care.
                    </div>
                    <div class="slds-text-body_small slds-text-color_default slds-p-top_medium">
                      By clicking the button, you agree to allow {!v.companyName} to split the total payment value into multiple transactions. If your account is subscribed to more than one solar project each subscription will be billed separately but never more than the total payment shown above. If you would like a detailed list of transactions, please see the paper bill that was emailed to you or reach out to {!v.companyName} at {!v.customerCareEmail}.
                    </div>
                  </aura:if>
                </aura:set>
              </aura:if>
            </aura:set>
          </aura:if>
        </div>
      </article>
    </aura:set>
  </aura:if>

</aura:component>