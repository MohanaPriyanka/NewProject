<aura:component implements="forceCommunity:availableForAllPageTypes" extends="c:BlueWaveForm" controller="SLPAddCustomer" access="global">
  <ltng:require styles="{!$Resource.animations}" />
  <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
  <aura:handler event="c:SLPSendApplicationEmailEvent" action="{!c.openEmailCustomerModal}" />
  <aura:registerEvent name="openSendCustomerEmail" type="c:SLPSendApplicationEmailEvent"/>
  <aura:registerEvent name="apexErrorEvent" type="c:ApexCallbackError"/>
  <aura:attribute name="partnerRecord" type="Object" />
  <aura:attribute name="disableOrigination" type="Boolean" default="false"/>
  <aura:attribute name="activeStates" type="List" />
  <aura:attribute name="downPayment" type="Decimal" />
  <aura:attribute name="customerEmail" type="String" />
  <aura:attribute name="availableLoanProducts" type="Product2[]"/>
  <aura:attribute name="availableSRECProducts" type="Product2[]"/>
  <aura:attribute name="productProgram" type="String"/>
  <aura:attribute name="iblsRequired" type="Boolean"/>
  <aura:attribute name="newLead" type="Lead" 
    default="{ 'sobjectType' : 'Lead',
    'FirstName': '',
    'LastName': '',
    'LASERCA__Home_State__c': '',
    'Email': '',
    'Product_Program__c': '',
    'Requested_Loan_Amount__c':'',
    'System_Cost__c':'',
    'Product__c':'',
    'DOER_Solar_Loan__c':'',
    'SREC_Product__c':'',
    }"/>  
  <div id="emailCustomerModal" aura:id="emailCustomerModal">
    <div aura:id="emailCustomerModal2">
      <div class="slds-m-bottom_small" aura:id="emailForm">
        <div>
          <aura:if isTrue="{!v.disableOrigination}">
            <div class="proximaNovaBlue">
              {!$Label.c.SLP_Disabled}
            </div>
            <aura:set attribute="else">
              <div class="slds-tabs--default box">
                <fieldset class="slds-form--compound slds-m-top_small">
                  <div class="proximaNovaStream slds-m-left_small slds-m-bottom_small slds-m-top_small"> <b><h3>Applicant Information </h3></b> </div>
                  <div class="slds-form-element__group">
                    <div class="slds-form-element__row">
                      <div aura:id="firstNameElement" class="slds-form-element slds-m-bottom_small slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"> <b>First Name</b> </label>
                        <ui:inputText aura:id="firstName" class="slds-input" value="{!v.newLead.FirstName}"  />
                      </div>
                      <div aura:id="lastNameElement" class="slds-form-element slds-m-bottom_small slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"> <b>Last Name</b> </label>
                        <ui:inputText aura:id="lastName" class="slds-input" value="{!v.newLead.LastName}"  />
                      </div>
                    </div>
                  </div>
                </fieldset>
                <fieldset class="slds-form--compound ">
                  <div class="slds-form-element__group">
                    <div class="slds-form-element__row">
                      <div aura:id="emailAddressElement" class="slds-form-element slds-m-bottom_small slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"> <b>Email Address</b> </label>
                        <ui:inputText aura:id="emailAddress" class="slds-input" value="{!v.newLead.Email}"  />
                      </div>
                      <div aura:id="stateElement" class="slds-form-element slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"><b>Home State</b></label>
                        <ui:inputSelect aura:id="state" class="slds-input" value="{!v.newLead.LASERCA__Home_State__c}" change="{!c.getAvailableProducts}"> 
                          <ui:inputSelectOption text="Select"/> 
                          <aura:iteration items="{!v.activeStates}" var="state">
                            <ui:inputSelectOption text="{!state}"/>
                          </aura:iteration>
                        </ui:inputSelect>
                      </div>
                    </div>
                  </div>
                </fieldset>
                <fieldset class="slds-form--compound">
                  <div class="slds-form-element__group">
                    <div class="slds-form-element__row">
                      <div aura:id="systemCostElement" class="slds-form-element slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"><b>Total System Cost</b>&nbsp;
                          <c:BlueWaveInputToolTip popoverText="Total installation system cost, inclusive of down payments. 
                                                               The applicant's requested loan amount is the difference between 
                                                               total system cost and down payment."/>
                        </label>
                        <div class="slds-form-element__control">
                          <ui:inputCurrency aura:id="systemCost" class="slds-input" value="{!v.newLead.System_Cost__c}" required="true"/>
                        </div>
                      </div>      
                      <div aura:id="downPaymentElement" class="slds-form-element slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"><b>Down Payment on System</b>&nbsp;
                          <c:BlueWaveInputToolTip placementLeft="true" popoverText="If the customer has made a down payment on their system, 
                                                                                    please enter its value here. The applicant's requested loan amount will be the difference of the total system cost and this down payment."/>
                        </label>
                        <ui:inputCurrency aura:id="downPayment" class="slds-input" value="{!v.downPayment}" required="true"/>
                      </div>
                    </div>
                    <div class="slds-form-element__row">
                      <div aura:id="loanAmountElement" class="slds-form-element slds-p-horizontal--small slds-size_1-of-2 animated">
                        <label class="slds-form-element__label proximaNovaBlue"><b>Requested Loan Amount</b></label>
                        <div class="slds-form-element__control">
                          <ui:outputCurrency aura:id="loanAmount" class="slds-input" value="{!if(v.downPayment!=null,v.newLead.System_Cost__c - v.downPayment,v.newLead.System_Cost__c)}"/>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="slds-form-element__row">
                    <div aura:id="productElement" class="slds-form-element slds-p-horizontal--small slds-size_1-of-1">
                      <label class="slds-form-element__label proximaNovaBlue"><b>Product</b></label>
                      <div class="slds-form-element__control">
                        <ui:inputSelect aura:id="productSelection" class="slds-input" value="{!v.newLead.Product__c}" change="{!c.setProductProgram}">
                          <aura:if isTrue="{!v.newLead.LASERCA__Home_State__c == 'MA'}">
                            <ui:inputSelectOption text="" label="Select"/>
                            <ui:inputSelectOption text="BlueWave Solar Loan" label="BlueWave Solar Loan"/>
                            <ui:inputSelectOption text="MSLP" label="Mass Solar Loan (MCEC)"/>
                            <aura:set attribute="else">
                              <ui:inputSelectOption label="Choose from qualifying products later" text=""/>
                              <aura:iteration items="{!v.availableLoanProducts}" var="product">
                                <ui:inputSelectOption label="{!product.Name}" text="{!product.Id}"/>
                              </aura:iteration>
                            </aura:set>
                          </aura:if>
                        </ui:inputSelect>
                      </div>
                    </div>
                  </div>
                  <aura:if isTrue="{!v.newLead.LASERCA__Home_State__c == 'MA'}">
                    <div class="slds-form-element__row">
                      <div aura:id="srecElement" class="slds-form-element slds-p-horizontal--small slds-size_1-of-1">
                        <label class="slds-form-element__label proximaNovaBlue"><b>SREC Product</b></label>
                        <div class="slds-form-element__control">
                          <ui:inputSelect aura:id="srecSelection" class="slds-input" value="{!v.newLead.SREC_Product__c}">
                            <aura:iteration items="{!v.availableSRECProducts}" var="product">
                              <ui:inputSelectOption label="{!product.Name}" text="{!product.Id}"/>
                            </aura:iteration>
                          </ui:inputSelect>
                        </div>
                      </div>
                    </div>
                  </aura:if>
                  <aura:if isTrue="{!and(v.iblsRequired, v.newLead.Product__c == 'MSLP')}">
                    <div class="slds-form-element__row slds-p-horizontal--small slds-m-top_medium slds-form-element__label">
                      <b>
                        Applicants will need to meet the Massachusetts Clean Energy Technology Center's (MassCEC) Income-Based Loan Support (IBLS) requirements to apply for a Mass Solar Loan Program (MSLP) loan from BlueWave's bank partner.  Applicants who do not meet IBLS requirements may still be eligible for a MSLP loan through MassCEC.
                        <c:BlueWaveInputToolTip placementLeft="false"> 
                          <aura:set attribute="popoverBody">
                            <c:SLPIBLSRequirements/>
                          </aura:set>
                        </c:BlueWaveInputToolTip>
                      </b>
                    </div>
                  </aura:if>
                </fieldset>
              </div>
            </aura:set>
          </aura:if>
        </div>
      </div>
      <div aura:id="emailConfirmation" class="noDisplay slds-m-bottom_small box">
        <div class="slds-p-around--medium">
          <div class="slds-align--absolute-center ">
            <p class="proximaNovaBlue slds-m-top_xx-large slds-m-bottom_xx-large"><b>The email has been sent, thank you!</b></p>
          </div>
        </div>
      </div>
      <div aura:id="sendEmailModalButtons" class="slds-float_right">
        <aura:if isTrue="{!not(v.disableOrigination)}">
          <lightning:button aura:id="sendEmailButton" class="slds-button slds-button--brand" iconName="utility:email" iconPosition="right" onclick="{!c.createLeadAndSendApplication}" label="Email"/>
          <lightning:button aura:id="openApplicationButton" class="slds-button slds-button--brand" onclick="{!c.createLeadAndOpenApplication}" label="Email and Open"/>
        </aura:if>
      </div>
      <ui:spinner aura:id="emailSpinner" class="floatRight" isVisible="false"/>
    </div>
  </div>
</aura:component>


