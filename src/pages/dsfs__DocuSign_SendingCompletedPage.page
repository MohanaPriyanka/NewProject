<apex:page controller="dsfs.SendingCompleteController"
           showHeader="true"
           sidebar="false">

    <apex:stylesheet value="{!$Resource.dsfs__styles}"/>
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"/>
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"/>
    <apex:includeScript value="{!$Resource.dsfs__modernizrjs}"/>
    <apex:includeScript value="{!$Resource.dsfs__html5shivjs}"/>
    <apex:includeScript value="{!$Resource.dsfs__UtilJS}"/>
    <script type="text/javascript">
        Visualforce.remoting.timeout = 120000;
        controller = {
            completeReview: '{!$RemoteAction.SendingCompleteController.completeReview}',
            isReviewEnabled: {!isReviewEnabled}
        };
        var newWindow = '{!JSENCODE($CurrentPage.parameters.NW)}' === '1';
        jQuery.noConflict();
        jQuery(document).ready(function ($) {
            // Remove any Classic stuff if in iframe.
            if (DSUtil.isInIFrame()) {
                $('#ds-header').remove();
                var appBodyHeader = $('#AppBodyHeader');
                if (DSUtil.isDefined(appBodyHeader)) {
                    appBodyHeader.remove();
                }
                $(document.body).removeClass('hasMotif homeTab sfdcBody brandQuaternaryBgr');
            }
            $('.docusign-container').css('background-color', 'transparent');

            if (!Modernizr.svg) {
                $('.success-icon').attr('src', '{!$Resource.SuccessPNG}');
            }
            var signNowError = '{!JSENCODE($CurrentPage.parameters.signNowError)}';
            var dsAlert = $('#dsAlert');
            var reviewContent = $('#review-content');
            if (signNowError !== '') {
                dsAlert.find('ul').append('<li><p>' + decodeURIComponent(signNowError).replace(/\+/g, ' ') + '</p></li>');
                $('.alert-messages').addClass('info');
                dsAlert.show();
            }
            if (newWindow) {
                $('#sucess-content').hide();
                reviewContent.hide();
                $('#new-window-content').show();
            } else {
                $('#content').show();
            }
            if (signNowError === '' && controller.isReviewEnabled) {
                reviewContent.show();
            }
            $('#writeReviewButton').click(function () {
                window.open('https://appexchange.salesforce.com/listingDetail?listingId=a0N30000001taX4EAI&tab=r', '_blank');
                try {
                    Visualforce.remoting.Manager.invokeAction(controller.completeReview, function (result, event) {
                        //console.log(result);
                    });
                } catch (err) {
                    console.log(err);
                }
            });
        });
    </script>
    <table id="ds-header" cellpadding="0" cellspacing="0" style="padding-bottom: 5px">
        <tr>
            <td style="vertical-align: top">
                <img class="dsLogo" src="{!$Resource.DocuSign}" title="{!$Label.DocuSignInc}."/>
            </td>
            <td style="vertical-align: top; padding-left: 5px">
                <h1>
                    <apex:outputText value="{!sourceDisplay}"/>
                </h1>
                <br/>{!$Label.Envelope}:&nbsp;<apex:outputText value="{!envelopeName}"/>
            </td>
        </tr>
    </table>
    <div class="docusign-container">
        <div id="dsAlert" style="display: none">
            <ul class="alert-messages"></ul>
        </div>
        <div class="success">
            <img class="success-icon" src="{!$Resource.Success}"/>
            <div class="success-content" id="content" style="display: none">
                <h1>{!$Label.DocuSignSendingCompleted}</h1>
                <p>{!$Label.YourDocEmailedInPdf}</p>
                <input type="hidden" value="{!envelopeId}" name="envelopeId"/>
                <a href="#" onclick="DSUtil.navigateToSObject('{!sourceId}', '{!pathPrefix}');"
                   class="secondary button">{!$Label.ReturnTo} {!sourceLabel}</a>
                <div id="review-content" style="display: none">
                    <hr/>
                    <h1>{!$Label.RateUs}</h1>
                    <p>{!$Label.ShareExperienceWithCommunity}</p>
                    <a href="javascript:void(0);" id="writeReviewButton"
                       class="secondary button">{!$Label.WriteAReview}</a>
                </div>
            </div>
            <div class="success-content" id="new-window-content" style="display:none">
                <h1>{!$Label.DocuSignSendingCompleted}!</h1>
                <p>{!$Label.EnvelopeSent}</p>
                <a href="#" onclick="DSUtil.closeWindow('{!sourceId}');" class="secondary button">{!$Label.CloseWindow}</a>
            </div>
        </div>
    </div>
</apex:page>