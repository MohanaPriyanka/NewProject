<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <assignments>
        <name>assign_to_new_invoice</name>
        <label>assign to new invoice</label>
        <locationX>960</locationX>
        <locationY>192</locationY>
        <assignmentItems>
            <assignToReference>colvarCPdupes.Invoice__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>ActiveInvoiceID</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>assign_to_update_list</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>assign_to_update_list</name>
        <label>assign to update list</label>
        <locationX>957</locationX>
        <locationY>332</locationY>
        <assignmentItems>
            <assignToReference>updatelistCPs</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>colvarCPdupes</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>look_through_CP_list</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Is_OG_Invoice_the_First_Invoice</name>
        <label>Is OG Invoice the First Invoice?</label>
        <locationX>173</locationX>
        <locationY>212</locationY>
        <defaultConnectorLabel>[Default Outcome]</defaultConnectorLabel>
        <rules>
            <name>Yes_it_is</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>duplicateinvoices.Id</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>ActiveInvoiceID</elementReference>
                </rightValue>
            </conditions>
            <label>Yes, it is</label>
        </rules>
        <rules>
            <name>Not_It_s_Not</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>duplicateinvoices.Id</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>ActiveInvoiceID</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>lookupcommissionpayments</targetReference>
            </connector>
            <label>Not, It&apos;s Not</label>
        </rules>
    </decisions>
    <formulas>
        <name>CommissionAmountDue</name>
        <dataType>Currency</dataType>
        <expression>CASE({!varCommissionPaymentType},
&quot;Contract Execution&quot;,{!UpFrontAmountDue},
&quot;First Bill Sent&quot;,{!FirstBillCommission},
&quot;First Bill Paid&quot;,{!FirstBillPaidCommission},
0)</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>CommissionPaymentName</name>
        <dataType>String</dataType>
        <expression>{!PartnerName}  &amp; &quot; &quot; &amp; {!OpportunityName} &amp; &quot; &quot; &amp; {!varCommissionPaymentType}</expression>
    </formulas>
    <formulas>
        <name>FirstBillCommissionAmount</name>
        <dataType>Currency</dataType>
        <expression>{!FirstBillCommission}*{!kWDCSubscriptionTotal}*1000</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>FirstBillPaidCommissionAmount</name>
        <dataType>Currency</dataType>
        <expression>{!FirstBillPaidCommission}*{!kWDCSubscriptionTotal}*1000</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>InvoiceAccountingDueDate</name>
        <dataType>Date</dataType>
        <expression>DATE(
IF(MONTH(TODAY())=12,
YEAR(TODAY()+1),
YEAR(TODAY())),
IF(MONTH(TODAY())=12,
1,
MONTH(TODAY())+1),
3)</expression>
    </formulas>
    <formulas>
        <description>This insures that the commission payment is attached to an invoice that is due in at least 2 weeks. That is the time we need to QC a commission payment and an agreed turnaround time with partners.</description>
        <name>InvoiceCutoffDate</name>
        <dataType>Date</dataType>
        <expression>Today()+15</expression>
    </formulas>
    <formulas>
        <name>InvoiceDueDate</name>
        <dataType>Date</dataType>
        <expression>DATE(
IF(MONTH(TODAY())=12,
YEAR(TODAY()+1),
YEAR(TODAY())),
IF(MONTH(TODAY())=12,
1,
MONTH(TODAY())+1),
15)</expression>
    </formulas>
    <formulas>
        <name>InvoiceName</name>
        <dataType>String</dataType>
        <expression>{!PartnerName} &amp; &quot; &quot; &amp; CASE(MONTH({!InvoiceDueDate}),
1, &quot;January&quot;,
2, &quot;February&quot;,
3, &quot;March&quot;,
4, &quot;April&quot;,
5, &quot;May&quot;,
6, &quot;June&quot;,
7, &quot;July&quot;,
8, &quot;August&quot;,
9, &quot;September&quot;,
10, &quot;October&quot;,
11, &quot;November&quot;,
12, &quot;December&quot;,
&quot;None&quot;)</expression>
    </formulas>
    <formulas>
        <name>Today</name>
        <dataType>Date</dataType>
        <expression>TODAY()</expression>
    </formulas>
    <formulas>
        <name>UpFrontAmountDue</name>
        <dataType>Currency</dataType>
        <expression>{!UpFrontCommission}*{!kWDCSubscriptionTotal}*1000</expression>
        <scale>2</scale>
    </formulas>
    <formulas>
        <name>waittime</name>
        <dataType>DateTime</dataType>
        <expression>{!$Flow.CurrentDateTime}-59</expression>
    </formulas>
    <interviewLabel>CS Partner Invoice Deduplication {!$Flow.CurrentDateTime}</interviewLabel>
    <label>CS Partner Invoice Deduplication</label>
    <loops>
        <name>look_through_CP_list</name>
        <label>look through CP list</label>
        <locationX>441</locationX>
        <locationY>330</locationY>
        <assignNextValueToReference>colvarCPdupes</assignNextValueToReference>
        <collectionReference>listupdateCPs</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>assign_to_new_invoice</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>update_comm_payments</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordDeletes>
        <name>delete_duplicate_invoices</name>
        <label>delete duplicate invoices</label>
        <locationX>43</locationX>
        <locationY>694</locationY>
        <inputReference>duplicateinvoices</inputReference>
    </recordDeletes>
    <recordLookups>
        <name>lookup_first_invoice</name>
        <label>lookup first invoice</label>
        <locationX>45</locationX>
        <locationY>211</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Is_OG_Invoice_the_First_Invoice</targetReference>
        </connector>
        <filters>
            <field>Due_Date__c</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>InvoiceCutoffDate</elementReference>
            </value>
        </filters>
        <filters>
            <field>Invoice_Type__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Direct</stringValue>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>varInvoiceName</elementReference>
            </value>
        </filters>
        <filters>
            <field>Partner__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>PartnerID</elementReference>
            </value>
        </filters>
        <filters>
            <field>Status__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Received &gt;&gt; QC</stringValue>
            </value>
        </filters>
        <object>Invoice__c</object>
        <outputAssignments>
            <assignToReference>ActiveInvoiceID</assignToReference>
            <field>Id</field>
        </outputAssignments>
        <sortField>Due_Date__c</sortField>
        <sortOrder>Asc</sortOrder>
    </recordLookups>
    <recordLookups>
        <name>lookupcommissionpayments</name>
        <label>lookupcommissionpayments</label>
        <locationX>441</locationX>
        <locationY>210</locationY>
        <assignNullValuesIfNoRecordsFound>true</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>look_through_CP_list</targetReference>
        </connector>
        <filters>
            <field>Invoice_Name__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>varInvoiceName</elementReference>
            </value>
        </filters>
        <filters>
            <field>Invoice__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>duplicateinvoices.Id</elementReference>
            </value>
        </filters>
        <object>Commission_Payment__c</object>
        <outputReference>listupdateCPs</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Invoice__c</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>update_comm_payments</name>
        <label>update comm payments</label>
        <locationX>443</locationX>
        <locationY>503</locationY>
        <connector>
            <targetReference>wait_0</targetReference>
        </connector>
        <inputReference>updatelistCPs</inputReference>
    </recordUpdates>
    <startElementReference>wait</startElementReference>
    <status>Active</status>
    <textTemplates>
        <name>casedescription</name>
        <text>Alert: There was an issue with the creation of the {!varCommissionPaymentType} commission payment record for this opportunity: ({!OpportunityName} {!OpportunityID} ). 

If this is a Contract Execution commission payment, then there was no active commission structure for the partner. If this is the first bill paid or first bill sent commission payment, then there was no commission struture attached to the opportunity.</text>
    </textTemplates>
    <textTemplates>
        <name>Partnercasesubject</name>
        <text>Alert: Issue with the creation of the {!varCommissionPaymentType} commission payment for ({!OpportunityName} {!OpportunityID})</text>
    </textTemplates>
    <variables>
        <name>ActiveCommissionStructure</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ActiveInvoice</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>ActiveInvoiceID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>colvarCPdupes</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Commission_Payment__c</objectType>
    </variables>
    <variables>
        <name>duplicatecommission</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>duplicateinvoices</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>finaldeletionlist</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>FirstBillCommission</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <scale>4</scale>
    </variables>
    <variables>
        <name>FirstBillPaidCommission</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <scale>4</scale>
    </variables>
    <variables>
        <name>inv2</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>kWDCSubscriptionTotal</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <scale>4</scale>
    </variables>
    <variables>
        <name>kwDCTotal</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>listDupInvfordeletion</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>listDuplicateInvoices</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>listupdateCPs</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Commission_Payment__c</objectType>
    </variables>
    <variables>
        <name>OGInvoice</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>OpportunityID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>OpportunityName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>PartnerID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>PartnerName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>ProductID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>sovarDupInvoices</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Invoice__c</objectType>
    </variables>
    <variables>
        <name>test</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>UASlist</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Utility_Account_Subscription__c</objectType>
    </variables>
    <variables>
        <name>UASloopvar</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Utility_Account_Subscription__c</objectType>
    </variables>
    <variables>
        <name>updatelistCPs</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <objectType>Commission_Payment__c</objectType>
    </variables>
    <variables>
        <name>UpFrontCommission</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
        <scale>4</scale>
    </variables>
    <variables>
        <name>varcommissionpayment</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>varCommissionPaymentType</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>varComPaymentName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>varInvoiceName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>true</isOutput>
    </variables>
    <waits>
        <name>wait</name>
        <label>wait</label>
        <locationX>166</locationX>
        <locationY>50</locationY>
        <defaultConnectorLabel>[Default Path]</defaultConnectorLabel>
        <waitEvents>
            <name>waitt</name>
            <conditionLogic>and</conditionLogic>
            <connector>
                <targetReference>lookup_first_invoice</targetReference>
            </connector>
            <eventType>AlarmEvent</eventType>
            <inputParameters>
                <name>AlarmTime</name>
                <value>
                    <elementReference>waittime</elementReference>
                </value>
            </inputParameters>
            <inputParameters>
                <name>TimeOffset</name>
            </inputParameters>
            <inputParameters>
                <name>TimeOffsetUnit</name>
            </inputParameters>
            <label>waitt</label>
        </waitEvents>
    </waits>
    <waits>
        <name>wait_0</name>
        <label>wait</label>
        <locationX>48</locationX>
        <locationY>503</locationY>
        <defaultConnectorLabel>[Default Path]</defaultConnectorLabel>
        <waitEvents>
            <name>waitt_0</name>
            <conditionLogic>and</conditionLogic>
            <connector>
                <targetReference>delete_duplicate_invoices</targetReference>
            </connector>
            <eventType>AlarmEvent</eventType>
            <inputParameters>
                <name>AlarmTime</name>
                <value>
                    <elementReference>$Flow.CurrentDateTime</elementReference>
                </value>
            </inputParameters>
            <inputParameters>
                <name>TimeOffset</name>
                <value>
                    <numberValue>0.01</numberValue>
                </value>
            </inputParameters>
            <inputParameters>
                <name>TimeOffsetUnit</name>
                <value>
                    <stringValue>Hours</stringValue>
                </value>
            </inputParameters>
            <label>waitt</label>
        </waitEvents>
    </waits>
</Flow>
